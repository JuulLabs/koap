<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <style>
        table {
            border-collapse: collapse;
        }
		table, th, td {
			text-align: left;
			border: 1px solid black;
		}
        th, td {
            padding: 5px;
        }
        .column {
            flex: 50%;
        }
        .row {
            display: flex;
        }
        .vertinput, .vertlabel {
            display:block;
        }

    </style>
</head>
<body>
<div class="row">
    <div class="column" id="leftcol">
        <table id="inputtable">
            <tr>
                <th>Message</th>
                <td><select id="msgtype" name="msgtype">
                    <option selected="selected" value="UDP">UDP</option>
                    <option value="TCP">TCP</option>
                </select></td>
            </tr>
            <tr>
                <th>UDP Type</th>
                <td><select id="udpmsgtype" name="udpmsgtype">
                    <option selected="selected" value="confirmable">Confirmable</option>
                    <option value="nonconfirmable">NonConfirmable</option>
                    <option value="acknowledgement">Acknowledgement</option>
                    <option value="reset">Reset</option>
                </select></td>
            </tr>
            <tr>
                <th colspan="2">Select a code</th>
            </tr>
            <tr>
                <td colspan="2">
                    <input id="Response" value="Response" type="radio" name="radiocode" onchange="onRadioSelectionChanged(this)"><label>Response</label>
                    <input id="Raw" value="Raw" type="radio" name="radiocode" onchange="onRadioSelectionChanged(this)"><label>Raw</label>
                    <input id="Method" value="Method" type="radio" name="radiocode" onchange="onRadioSelectionChanged(this)" checked><label>Method</label></td>
            </tr>
            <tr>
                <td colspan="2">
                    <div id="coderesponsediv">
                        <select id="codetyperesponseselect">
                            <option value="created">Created</option>
                            <option value="deleted">Deleted</option>
                            <option value="valid">Valid</option>
                            <option value="changed">Changed</option>
                            <option value="content">Content</option>
                            <option value="badrequest">BadRequest</option>
                            <option value="unauthorized">Unauthorized</option>
                            <option value="badoption">BadOption</option>
                            <option value="forbidden">Forbidden</option>
                            <option value="notfound">NotFound</option>
                            <option value="methodnotallowed">MethodNotAllowed</option>
                            <option value="notacceptable">NotAcceptable</option>
                            <option value="preconditionfailed">PreconditionFailed</option>
                            <option value="requestentitytoolarge">RequestEntityTooLarge</option>
                            <option value="unsupportedcontentformat">UnsupportedContentFormat</option>
                            <option value="internalservererror">InternalServerError</option>
                            <option value="notimplemented">NotImplemented</option>
                            <option value="badgateway">BadGateway</option>
                            <option value="serviceunavailable">ServiceUnavailable</option>
                            <option value="gatewaytimeout">GatewayTimeout</option>
                            <option value="proxyingnotsupported">ProxyingNotSupported</option>
                        </select>
                    </div>
                    <div id="codemethoddiv">
                        <select id="codetypemethodselect" >
                            <option value="get">GET</option>
                            <option value="delete">DELETE</option>
                            <option value="post">POST</option>
                            <option value="put">PUT</option>
                        </select>
                    </div>
                    <div id="coderawdiv">
                        <label for="coderawclass" class="vertlabel">Raw class range 0..7</label>
                        <input type="number" min="0" max="7" id="coderawclass" class="vertinput">
                        <label for="coderawclass" class="vertlabel">Raw detail range 0..31</label>
                        <input type="number" min="0" max="31" id="coderawdetail" class="vertinput">
                    </div>
                </td>
            </tr>
            <tr>
                <th>ID</th>
                <td><input id="msgid" type="text"></td>
            </tr>
            <tr>
                <th>Token</th>
                <td><input id="token" type="text"></td>
            </tr>
            <tr>
                <th>Options</th>
                <td>
                    <select id="optionsselect">
                        <option value="ifmatch">IfMatch</option>
                        <option value="urihost">UriHost</option>
                        <option value="etag">ETag</option>
                        <option value="ifnonematch">IfNoneMatch</option>
                        <option value="observe">Observe</option>
                        <option value="uriport">UriPort</option>
                        <option value="locationpath">LocationPath</option>
                        <option value="uripath">UriPath</option>
                        <option value="contentformat">ContentFormat</option>
                        <option value="maxage">MaxAge</option>
                        <option value="uriquery">UriQuery</option>
                        <option value="accept">Accept</option>
                        <option value="locationquery">LocationQuery</option>
                        <option value="proxyuri">ProxyUri</option>
                        <option value="proxyscheme">ProxyScheme</option>
                        <option value="size1">Size1</option>
                    </select>
                    <input type="text" id="optioninput">
                </td>
<!--                <td><input id="options" type="text"></td>-->
            </tr>
            <tr>
                <th>Payload</th>
                <td><input id="payload" type="text"></td>
            </tr>
            <tr>
                <td colspan="2">
                    <button id="encodebutton" name="encodebutton" onclick="onEncodeClick()">Encode --&gt;</button>
                </td>
            </tr>
        </table>
    </div>
    <div class="column" id="rightcol"><textarea id="decodedtext"></textarea><br>
        <button id="decodebutton" name="decodebutton">&lt;-- Decode</button>
    </div>
</div>
<script src="koap.js"></script>
<script>
    var messageTypeSelect = document.getElementById("msgtype");
    var udpMessageTypeSelect = document.getElementById("udpmsgtype");
    var codeTypeRadioNodeList = document.getElementsByName("radiocode");
    var codeTypeResponseSelect = document.getElementById("codetyperesponseselect");
    var codeTypeMethodSelect = document.getElementById("codetypemethodselect");
    var codeRawClassInput = document.getElementById("coderawclass");
    var codeRawDetailInput = document.getElementById("coderawdetail");
    var messageIdInput = document.getElementById("msgid");
    var tokenInput = document.getElementById("token");
    var payloadInput = document.getElementById("payload");
    var optionSelect = document.getElementById("optionsselect");
    var optionInput = document.getElementById("optioninput");
    var encodeButton = document.getElementById("encodebutton");
    var decodeButton = document.getElementById("decodebutton");
    var decodeTextArea = document.getElementById("decodedtext");
    var rawDiv = document.getElementById("coderawdiv");
    var methodDiv = document.getElementById("codemethoddiv");
    var responseDiv = document.getElementById("coderesponsediv");

    var codeResponseMap = {
            "created": koap.com.juul.koap.Message.Code.Response.Created,
            "deleted": koap.com.juul.koap.Message.Code.Response.Deleted,
            "valid": koap.com.juul.koap.Message.Code.Response.Valid,
            "changed": koap.com.juul.koap.Message.Code.Response.Changed,
            "content": koap.com.juul.koap.Message.Code.Response.Content,
            "badrequest": koap.com.juul.koap.Message.Code.Response.BadRequest,
            "unauthorized": koap.com.juul.koap.Message.Code.Response.Unauthorized,
            "badoption": koap.com.juul.koap.Message.Code.Response.BadOption,
            "forbidden": koap.com.juul.koap.Message.Code.Response.Forbidden,
            "notfound": koap.com.juul.koap.Message.Code.Response.NotFound,
            "methodnotallowed": koap.com.juul.koap.Message.Code.Response.MethodNotAllowed,
            "notacceptable": koap.com.juul.koap.Message.Code.Response.NotAcceptable,
            "preconditionfailed": koap.com.juul.koap.Message.Code.Response.PreconditionFailed,
            "requestentitytoolarge": koap.com.juul.koap.Message.Code.Response.RequestEntityTooLarge,
            "unsupportedcontentformat": koap.com.juul.koap.Message.Code.Response.UnsupportedContentFormat,
            "internalservererror": koap.com.juul.koap.Message.Code.Response.InternalServerError,
            "notimplemented": koap.com.juul.koap.Message.Code.Response.NotImplemented,
            "badgateway": koap.com.juul.koap.Message.Code.Response.BadGateway,
            "serviceunavailable": koap.com.juul.koap.Message.Code.Response.ServiceUnavailable,
            "gatewaytimeout": koap.com.juul.koap.Message.Code.Response.GatewayTimeout,
            "proxyingnotsupported": koap.com.juul.koap.Message.Code.Response.ProxyingNotSupported
        };

    var codeMethodMap = {
        "get": koap.com.juul.koap.Message.Code.Method.GET,
        "delete": koap.com.juul.koap.Message.Code.Method.DELETE,
        "post": koap.com.juul.koap.Message.Code.Method.POST,
        "put": koap.com.juul.koap.Message.Code.Method.PUT
    }

    var udpTypeMap = {
        "confirmable": koap.com.juul.koap.Message.Udp.Type.Confirmable,
        "nonconfirmable": koap.com.juul.koap.Message.Udp.Type.NonConfirmable,
        "acknowledgement": koap.com.juul.koap.Message.Udp.Type.Acknowledgement,
        "reset": koap.com.juul.koap.Message.Udp.Type.Reset
    };

    hideDiv(rawDiv);
    hideDiv(responseDiv);

    messageTypeSelect.addEventListener("change", function(evt) {
        console.log(this.value);
        if (this.value == "UDP") {
            setupUdpFields(udpMessageTypeSelect, messageIdInput);
        } else if (this.value == "TCP") {
            setupTcpFields(udpMessageTypeSelect, messageIdInput);
        }
    });

    function onEncodeClick() {

        let codeTypeValue = getCodeTypeForSelection(codeTypeRadioNodeList, codeResponseMap, codeMethodMap);
        let options = new Array(getOptionForSelection());
        console.log("got options: " + options);

        if (messageTypeSelect.value == "UDP") {
            var msg = new koap.com.juul.koap.Message.Udp(
                udpTypeMap[udpMessageTypeSelect.value],
                codeTypeValue,
                parseInt(messageIdInput.value),
                parseInt(tokenInput.value),
                options,
                strToInt8(payloadInput.value)
            );
<!--            console.log("message: " + msg);-->
            decodeTextArea.value = "";
            decodeTextArea.value = koap.com.juul.koap.encode(msg);
        } else if (messageTypeSelect.value == "TCP") {
            let msg = new koap.com.juul.koap.Message.Tcp(
                codeTypeValue,
                parseInt(tokenInput.value),
                options,
                strToInt8(payloadInput.value)
            );
            decodeTextArea.value = "";
            decodeTextArea.value = koap.com.juul.koap.encode(msg);
        } else {
            alert("Message type selection unknown");
        }
    }

    function strToInt8(str) {
        let int8 = new Int8Array(str.length);
        for (let i = 0; i < str.length; i++) {
            int8[i] = str.charCodeAt(i);
        }
        return int8;
    }

    function int8ToStr(int8Array) {
<!--        TODO implement for decode-->
    }

<!--    TODO can this use reflection?-->
    function getOptionForSelection() {
        console.log("switching on: " + optionSelect.value);
        switch(optionSelect.value) {
            case "ifmatch":
                return new koap.com.juul.koap.Message.Option.IfMatch(strToInt8(optionInput.value));
                break;
            case "urihost":
                return new koap.com.juul.koap.Message.Option.UriHost(optionInput.value);
                break;
            case "etag":
                return new koap.com.juul.koap.Message.Option.ETag(strToInt8(optionInput.value));
                break;
            case "ifnonematch":
                return koap.com.juul.koap.Message.Option.IfNoneMatch;
                break;
            case "observe":
                return new koap.com.juul.koap.Message.Option.Observe(parseInt(optionInput.value));
                break;
            case "uriport":
                return new koap.com.juul.koap.Message.Option.UriPort(parseInt(optionInput.value));
                break;
            case "locationpath":
                return new koap.com.juul.koap.Message.Option.LocationPath(optionInput.value);
                break;
            case "uripath":
                return new koap.com.juul.koap.Message.Option.UriPath(optionInput.value);
                break;
            case "contentformat":
                return new koap.com.juul.koap.Message.Option.ContentFormat(parseInt(optionInput.value));
                break;
            case "maxage":
                return new koap.com.juul.koap.Message.Option.MaxAge(parseInt(optionInput.value));
                break;
            case "uriquery":
                return new koap.com.juul.koap.Message.Option.UriQuery(optionInput.value);
                break;
            case "accept":
                return new koap.com.juul.koap.Message.Option.Accept(parseInt(optionInput.value));
                break;
            case "locationquery":
                return new koap.com.juul.koap.Message.Option.LocationQuery(optionInput.value);
                break;
            case "proxyuri":
                return new koap.com.juul.koap.Message.Option.ProxyUri(optionInput.value);
                break;
            case "proxyscheme":
                return new koap.com.juul.koap.Message.Option.ProxyScheme(optionInput.value);
                break;
            case "size1":
                return new koap.com.juul.koap.Message.Option.Size1(parseInt(optionInput.value));
                break;
            default:
                return null;
        }
    }

    function getCodeTypeForSelection(radioNodeList, responseMap, methodMap) {
        for (let i = 0; i < radioNodeList.length; i++) {
            console.log("value: " + radioNodeList[i].value);
            if (radioNodeList[i].value == "Response" && radioNodeList[i].checked) {
                return responseMap[codeTypeResponseSelect.value];
            } else if (radioNodeList[i].value == "Raw" && radioNodeList[i].checked) {
                return new koap.com.juul.koap.Message.Code.Raw(parseInt(codeRawClassInput.value), parseInt(codeRawDetailInput.value));
            } else if (radioNodeList[i].value == "Method" && radioNodeList[i].checked) {
                return methodMap[codeTypeMethodSelect.value];
            }
        }
    }

    function onRadioSelectionChanged(radInput) {
        var rawDiv = document.getElementById("coderawdiv")
        var methodDiv = document.getElementById("codemethoddiv")
        var responseDiv = document.getElementById("coderesponsediv")

        if (radInput.value == "Response") {
            showDiv(responseDiv);
            hideDiv(methodDiv);
            hideDiv(rawDiv);
        } else if (radInput.value == "Raw") {
            hideDiv(responseDiv);
            hideDiv(methodDiv);
            showDiv(rawDiv);
        } else if (radInput.value == "Method") {
            hideDiv(responseDiv);
            showDiv(methodDiv);
            hideDiv(rawDiv);
        }
    }

    function showDiv(divToShow) {
        divToShow.style.display = "block"
        divToShow.style.visibility = "visible"
    }

    function hideDiv(divToHide) {
        divToHide.style.display = "none"
    }

    function setupTcpFields(udpMsgTypeSelect, messageId) {
        udpMsgTypeSelect.disabled = true;
        messageId.disabled = true;
    }

    function setupUdpFields(udpMsgTypeSelect, messageId) {
        udpMsgTypeSelect.disabled = false;
        messageId.disabled = false;
    }
</script>
</body>
</html>