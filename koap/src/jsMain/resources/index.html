<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <style>
        table {
            border-collapse: collapse;
            width: 80%;
        }
		table, th, td {
			text-align: left;
			border: 1px solid black;
		}
        th, td {
            padding: 5px;
        }
        .vertinput, .vertlabel {
            display:block;
        }
        textarea {
            width: 100%;
            min-height:300px;
        }

    </style>
</head>
<body>
<div class="row">
        <table id="inputtable">
            <tr>
                <th>Message</th>
                <td><select id="msgtype" name="msgtype">
                    <option selected="selected" value="UDP">UDP</option>
                    <option value="TCP">TCP</option>
                </select></td>
                <td rowspan="9">
                    <textarea id="decodedtext" placeholder="42 01 F3 85 CA FE B7 ..."></textarea>
                </td>
            </tr>
            <tr>
                <th>UDP Type</th>
                <td><select id="udpmsgtype" name="udpmsgtype">
                    <option selected="selected" value="Confirmable">Confirmable</option>
                    <option value="NonConfirmable">NonConfirmable</option>
                    <option value="Acknowledgement">Acknowledgement</option>
                    <option value="Reset">Reset</option>
                </select></td>
            </tr>
            <tr>
                <th colspan="2">Select a code</th>
            </tr>
            <tr>
                <td colspan="2">
                    <input id="Response" value="Response" type="radio" name="radiocode" onchange="onRadioSelectionChanged(this)"><label>Response</label>
                    <input id="Raw" value="Raw" type="radio" name="radiocode" onchange="onRadioSelectionChanged(this)"><label>Raw</label>
                    <input id="Method" value="Method" type="radio" name="radiocode" onchange="onRadioSelectionChanged(this)" checked><label>Method</label></td>
            </tr>
            <tr>
                <td colspan="2">
                    <div id="coderesponsediv">
                        <select id="codetyperesponseselect">
                            <option value="Created">Created</option>
                            <option value="Deleted">Deleted</option>
                            <option value="Valid">Valid</option>
                            <option value="Changed">Changed</option>
                            <option value="Content">Content</option>
                            <option value="BadRequest">BadRequest</option>
                            <option value="Unauthorized">Unauthorized</option>
                            <option value="BadOption">BadOption</option>
                            <option value="Forbidden">Forbidden</option>
                            <option value="NotFound">NotFound</option>
                            <option value="MethodNotAllowed">MethodNotAllowed</option>
                            <option value="NotAcceptable">NotAcceptable</option>
                            <option value="PreconditionFailed">PreconditionFailed</option>
                            <option value="RequestEntityTooLarge">RequestEntityTooLarge</option>
                            <option value="UnsupportedContentFormat">UnsupportedContentFormat</option>
                            <option value="InternalServerError">InternalServerError</option>
                            <option value="NotImplemented">NotImplemented</option>
                            <option value="BadGateway">BadGateway</option>
                            <option value="ServiceUnavailable">ServiceUnavailable</option>
                            <option value="GatewayTimeout">GatewayTimeout</option>
                            <option value="ProxyingNotSupported">ProxyingNotSupported</option>
                        </select>
                    </div>
                    <div id="codemethoddiv">
                        <select id="codetypemethodselect" >
                            <option value="GET">GET</option>
                            <option value="DELETE">DELETE</option>
                            <option value="POST">POST</option>
                            <option value="PUT">PUT</option>
                        </select>
                    </div>
                    <div id="coderawdiv">
                        <label for="coderawclass" class="vertlabel">Raw class range 0..7</label>
                        <input type="number" min="0" max="7" id="coderawclass" class="vertinput">
                        <label for="coderawclass" class="vertlabel">Raw detail range 0..31</label>
                        <input type="number" min="0" max="31" id="coderawdetail" class="vertinput">
                    </div>
                </td>
            </tr>
            <tr>
                <th>ID</th>
                <td><input id="msgid" type="text"></td>
            </tr>
            <tr>
                <th>Token</th>
                <td><input id="token" type="text"></td>
            </tr>
            <tr>
                <th>Options</th>
                <td>
                    <select id="optionsselect">
                        <option value="IfMatch">IfMatch</option>
                        <option value="UriHost">UriHost</option>
                        <option value="ETag">ETag</option>
                        <option value="IfNoneMatch">IfNoneMatch</option>
                        <option value="Observe">Observe</option>
                        <option value="UriPort">UriPort</option>
                        <option value="LocationPath">LocationPath</option>
                        <option value="UriPath">UriPath</option>
                        <option value="ContentFormat">ContentFormat</option>
                        <option value="MaxAge">MaxAge</option>
                        <option value="UriQuery">UriQuery</option>
                        <option value="Accept">Accept</option>
                        <option value="LocationQuery">LocationQuery</option>
                        <option value="ProxyUri">ProxyUri</option>
                        <option value="ProxyScheme">ProxyScheme</option>
                        <option value="Size1">Size1</option>
                    </select>
                    <input type="text" id="optioninput">
                </td>
            </tr>
            <tr>
                <th>Payload</th>
                <td><input id="payload" type="text"></td>
            </tr>
            <tr>
                <td colspan="2">
                    <button id="encodebutton" name="encodebutton" onclick="onEncodeClick()">Encode</button>
                </td>
                <td>
                    <button id="decodeudpbutton" name="decodeudpbutton">DecodeUdp</button>
                    <button id="decodetcpbutton" name="decodetcpbutton">DecodeTcp</button>
                </td>
            </tr>
        </table>
</div>
<script src="koap.js"></script>
<script>

    var messageTypeSelect = document.getElementById("msgtype");
    var udpMessageTypeSelect = document.getElementById("udpmsgtype");
    var codeTypeRadioNodeList = document.getElementsByName("radiocode");
    var codeTypeResponseSelect = document.getElementById("codetyperesponseselect");
    var codeTypeMethodSelect = document.getElementById("codetypemethodselect");
    var codeRawClassInput = document.getElementById("coderawclass");
    var codeRawDetailInput = document.getElementById("coderawdetail");
    var messageIdInput = document.getElementById("msgid");
    var tokenInput = document.getElementById("token");
    var payloadInput = document.getElementById("payload");
    var optionSelect = document.getElementById("optionsselect");
    var optionInput = document.getElementById("optioninput");
    var encodeButton = document.getElementById("encodebutton");
    var decodeButton = document.getElementById("decodebutton");
    var decodeTextArea = document.getElementById("decodedtext");
    var rawDiv = document.getElementById("coderawdiv");
    var methodDiv = document.getElementById("codemethoddiv");
    var responseDiv = document.getElementById("coderesponsediv");

    hideDiv(rawDiv);
    hideDiv(responseDiv);

    messageTypeSelect.addEventListener("change", function(evt) {
        console.log(this.value);
        if (this.value == "UDP") {
            setupUdpFields(udpMessageTypeSelect, messageIdInput);
        } else if (this.value == "TCP") {
            setupTcpFields(udpMessageTypeSelect, messageIdInput);
        }
    });

    function onEncodeClick() {
        let messageObj = new Object();

        messageObj.messageType = messageTypeSelect.value;
        messageObj.code = getCodeTypeForSelection(codeTypeRadioNodeList);
        messageObj.type = udpMessageTypeSelect.value;

        if (messageTypeSelect.value == "UDP") {
            messageObj.id = parseInt(messageIdInput.value);
            messageObj.token = parseInt(tokenInput.value);
        }

        messageObj.options = [{
            type: optionSelect.value,
            value: optionInput.value
        }];
        messageObj.payload = payloadInput.value;

        let stringify = JSON.stringify(messageObj);
        console.log(stringify);
        decodeTextArea.value = "";
        decodeTextArea.value = koap.com.juul.koap.multiplatform.encodeFromJson(stringify);
    }

    function getCodeTypeForSelection(radioNodeList) {
        for (let i = 0; i < radioNodeList.length; i++) {
            console.log("value: " + radioNodeList[i].value);
            if (radioNodeList[i].value == "Response" && radioNodeList[i].checked) {
                return {
                    "#type": codeTypeResponseSelect.value
                };
            } else if (radioNodeList[i].value == "Raw" && radioNodeList[i].checked) {
                return {
                    "#type": "Raw",
                    "class": parseInt(codeRawClassInput.value),
                    "detail": parseInt(codeRawDetailInput.value)
                };
            } else if (radioNodeList[i].value == "Method" && radioNodeList[i].checked) {
                return {
                    "#type": codeTypeMethodSelect.value
                };
            }
        }
    }

    function onRadioSelectionChanged(radInput) {
        var rawDiv = document.getElementById("coderawdiv")
        var methodDiv = document.getElementById("codemethoddiv")
        var responseDiv = document.getElementById("coderesponsediv")

        if (radInput.value == "Response") {
            showDiv(responseDiv);
            hideDiv(methodDiv);
            hideDiv(rawDiv);
        } else if (radInput.value == "Raw") {
            hideDiv(responseDiv);
            hideDiv(methodDiv);
            showDiv(rawDiv);
        } else if (radInput.value == "Method") {
            hideDiv(responseDiv);
            showDiv(methodDiv);
            hideDiv(rawDiv);
        }
    }

    function showDiv(divToShow) {
        divToShow.style.display = "block"
        divToShow.style.visibility = "visible"
    }

    function hideDiv(divToHide) {
        divToHide.style.display = "none"
    }

    function setupTcpFields(udpMsgTypeSelect, messageId) {
        udpMsgTypeSelect.disabled = true;
        messageId.disabled = true;
    }

    function setupUdpFields(udpMsgTypeSelect, messageId) {
        udpMsgTypeSelect.disabled = false;
        messageId.disabled = false;
    }
</script>
</body>
</html>
